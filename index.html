<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Registra y visualiza los 177 Pueblos MÃ¡gicos de MÃ©xico que has visitado">
    <title>Mi Recorrido por los Pueblos MÃ¡gicos de MÃ©xico - 177 Pueblos</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tu-sitio-web.com/">
    <meta property="og:title" content="Mi Recorrido por los Pueblos MÃ¡gicos de MÃ©xico ðŸ‡²ðŸ‡½âœ¨">
    <meta property="og:description" content="Explora y registra tu aventura por los 177 Pueblos MÃ¡gicos oficiales de MÃ©xico. Visualiza tu progreso en un mapa interactivo.">
    <meta property="og:image" content="https://images.unsplash.com/photo-1518105779142-d975f22f1b0a?w=1200&h=630&fit=crop">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://tu-sitio-web.com/">
    <meta property="twitter:title" content="Mi Recorrido por los Pueblos MÃ¡gicos de MÃ©xico ðŸ‡²ðŸ‡½âœ¨">
    <meta property="twitter:description" content="Explora y registra tu aventura por los 177 Pueblos MÃ¡gicos oficiales de MÃ©xico. Visualiza tu progreso en un mapa interactivo.">
    <meta property="twitter:image" content="https://images.unsplash.com/photo-1518105779142-d975f22f1b0a?w=1200&h=630&fit=crop">
    
    <!-- Otros metadatos -->
    <meta name="keywords" content="Pueblos MÃ¡gicos, MÃ©xico, viajes, turismo, mapa interactivo, recorrido">
    <meta name="author" content="Pueblos MÃ¡gicos MÃ©xico">
    <meta name="theme-color" content="#d4145a">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary-color: #d4145a; 
            --secondary-color: #006847; 
            --accent-color: #ffd700; 
            --text-dark: #2c3e50; 
            --text-light: #7f8c8d; 
            --bg-light: #f8f9fa; 
            --bg-white: #ffffff; 
            --success: #27ae60; 
            --danger: #e74c3c; 
            --shadow: rgba(0, 0, 0, 0.1); 
            --shadow-hover: rgba(0, 0, 0, 0.15); 
        }
        body { 
            font-family: 'Poppins', sans-serif; 
            color: var(--text-dark); 
            background-color: var(--bg-light); 
            line-height: 1.6; 
            overflow-x: hidden; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); 
            color: white; 
            padding: 30px 0; 
            text-align: center; 
            box-shadow: 0 4px 6px var(--shadow); 
        }
        .header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 10px; }
        .header h1 i { margin-right: 15px; }
        .subtitle { font-size: 1.1rem; font-weight: 300; opacity: 0.95; }
        .stats-bar { background: white; padding: 25px 0; box-shadow: 0 2px 4px var(--shadow); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
        .stat-card { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            padding: 15px; 
            background: var(--bg-light); 
            border-radius: 12px; 
            transition: transform 0.3s ease; 
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { font-size: 2rem; color: var(--primary-color); }
        .stat-info { display: flex; flex-direction: column; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: var(--text-dark); line-height: 1; }
        .stat-label { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .tabs-container { 
            background: white; 
            border-bottom: 2px solid var(--bg-light); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 4px var(--shadow); 
        }
        .tabs { display: flex; gap: 5px; }
        .tab-button { 
            flex: 1; 
            padding: 18px 25px; 
            border: none; 
            background: transparent; 
            color: var(--text-light); 
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border-bottom: 3px solid transparent; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        .tab-button i { font-size: 1.2rem; }
        .tab-button:hover { color: var(--primary-color); background: var(--bg-light); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: var(--bg-light); }
        .main-content { padding: 30px 0; min-height: calc(100vh - 400px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .controls { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .search-box, .filter-box { 
            flex: 1; 
            min-width: 200px; 
            position: relative; 
            display: flex; 
            align-items: center; 
            background: white; 
            border-radius: 10px; 
            padding: 12px 15px; 
            box-shadow: 0 2px 4px var(--shadow); 
        }
        .search-box i, .filter-box i { color: var(--text-light); margin-right: 10px; }
        .search-box input, .filter-box select { 
            flex: 1; 
            border: none; 
            outline: none; 
            font-size: 1rem; 
            font-family: 'Poppins', sans-serif; 
            color: var(--text-dark); 
        }
        .btn-clear { 
            padding: 12px 20px; 
            background: var(--danger); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 4px var(--shadow); 
        }
        .btn-clear:hover { 
            background: #c0392b; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 8px var(--shadow-hover); 
        }
        .pueblos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .pueblo-card { 
            background: white; 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 2px 8px var(--shadow); 
            transition: all 0.3s ease; 
            cursor: pointer; 
            border: 3px solid transparent; 
        }
        .pueblo-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 16px var(--shadow-hover); 
        }
        .pueblo-card.visited { 
            border-color: var(--success); 
            background: linear-gradient(135deg, #ffffff 0%, #e8f5e9 100%); 
        }
        .pueblo-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .pueblo-name { font-size: 1.2rem; font-weight: 600; color: var(--text-dark); flex: 1; }
        .pueblo-checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: var(--success); }
        .pueblo-state { 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            font-size: 0.9rem; 
            color: var(--text-light); 
            margin-top: 8px; 
        }
        .pueblo-state i { color: var(--primary-color); }
        .map-info { 
            background: white; 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px var(--shadow); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .map-info i { color: var(--primary-color); font-size: 1.2rem; }
        #map { height: 600px; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); background: white; }
        .empty-state { text-align: center; padding: 50px 20px; color: var(--text-light); }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        .empty-state h3 { font-size: 1.5rem; margin-bottom: 10px; }
        .share-buttons { display: flex; gap: 15px; justify-content: center; padding: 20px 0; flex-wrap: wrap; }
        .share-btn { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.3s ease; 
            box-shadow: 0 2px 4px var(--shadow); 
            color: white; 
        }
        .share-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-hover); }
        .share-btn i { font-size: 1.2rem; }
        .btn-instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); }
        .btn-facebook { background: #1877f2; }
        .btn-tiktok { background: #000000; }
        .share-modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            animation: fadeIn 0.3s ease; 
        }
        .share-modal.active { display: flex; }
        .share-content { 
            background: white; 
            border-radius: 20px; 
            padding: 30px; 
            max-width: 900px; 
            width: 90%; 
            max-height: 90vh; 
            overflow-y: auto; 
            position: relative; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); 
        }
        .share-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .share-title { 
            font-size: 1.8rem; 
            font-weight: 700; 
            color: var(--primary-color); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .btn-close-modal { 
            background: var(--danger); 
            color: white; 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.3rem; 
            transition: all 0.3s ease; 
        }
        .btn-close-modal:hover { transform: rotate(90deg); background: #c0392b; }
        .share-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .share-stat { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
        }
        .share-stat-number { font-size: 2.5rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .share-stat-label { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.95; }
        #shareMap { height: 450px; border-radius: 15px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 20px; }
        .share-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-download, .btn-copy-link { 
            padding: 15px 30px; 
            border: none; 
            border-radius: 10px; 
            font-size: 1rem; 
            font-weight: 500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: all 0.3s ease; 
        }
        .btn-download { background: var(--success); color: white; }
        .btn-download:hover { background: #229954; }
        .btn-copy-link { background: var(--primary-color); color: white; }
        .btn-copy-link:hover { background: #b01148; }
        .footer { 
            background: var(--text-dark); 
            color: white; 
            text-align: center; 
            padding: 30px 0; 
            margin-top: 50px; 
        }
        .footer-note { font-size: 0.85rem; color: var(--text-light); margin-top: 10px; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8rem; }
            .subtitle { font-size: 0.95rem; }
            .stats-grid { grid-template-columns: 1fr; gap: 15px; }
            .stat-card { padding: 12px; }
            .stat-number { font-size: 1.5rem; }
            .tab-button { padding: 15px 10px; font-size: 0.9rem; }
            .tab-button span { display: none; }
            .tab-button i { font-size: 1.5rem; }
            .controls { flex-direction: column; }
            .search-box, .filter-box, .btn-clear { width: 100%; min-width: unset; }
            .pueblos-grid { grid-template-columns: 1fr; gap: 15px; }
            .pueblo-card { padding: 15px; }
            #map { height: 400px; }
            .container { padding: 0 15px; }
            .share-content { padding: 20px; width: 95%; }
            .share-title { font-size: 1.4rem; }
            .share-stat-number { font-size: 2rem; }
            #shareMap { height: 300px; }
            .share-actions { flex-direction: column; }
            .btn-download, .btn-copy-link { width: 100%; justify-content: center; }
        }
        @media (max-width: 480px) {
            .header h1 { font-size: 1.5rem; }
            .header { padding: 20px 0; }
            .main-content { padding: 20px 0; }
            .stat-icon { font-size: 1.5rem; }
            .stat-number { font-size: 1.3rem; }
            .pueblo-name { font-size: 1.1rem; }
        }
        
        /* Canvas para Instagram Stories - Oculto por defecto */
        #instagramCanvas {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1080px;
            height: 1920px;
            background: linear-gradient(135deg, #d4145a 0%, #006847 100%);
            font-family: 'Poppins', sans-serif;
        }
        .ig-container {
            width: 1080px;
            height: 1920px;
            padding: 80px 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
        }
        .ig-header {
            text-align: center;
            color: white;
        }
        .ig-title {
            font-size: 72px;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .ig-subtitle {
            font-size: 42px;
            font-weight: 300;
            opacity: 0.95;
        }
        .ig-stats-container {
            background: white;
            border-radius: 40px;
            padding: 60px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .ig-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 40px;
            margin-bottom: 60px;
        }
        .ig-stat-card {
            text-align: center;
            background: linear-gradient(135deg, #d4145a, #006847);
            padding: 50px 30px;
            border-radius: 30px;
        }
        .ig-stat-number {
            font-size: 96px;
            font-weight: 700;
            color: white;
            display: block;
            line-height: 1;
            margin-bottom: 15px;
        }
        .ig-stat-label {
            font-size: 32px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.95;
        }
        .ig-map-container {
            width: 100%;
            height: 800px;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .ig-footer {
            text-align: center;
            color: white;
        }
        .ig-footer-text {
            font-size: 36px;
            font-weight: 500;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .ig-footer-url {
            font-size: 32px;
            margin-top: 15px;
            opacity: 0.9;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #d4145a;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: white;
            font-size: 24px;
            margin-top: 30px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> Mis Pueblos MÃ¡gicos</h1>
            <p class="subtitle">Explora y registra tu recorrido por MÃ©xico - 177 Pueblos MÃ¡gicos</p>
        </div>
    </header>

    <div class="stats-bar">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <span class="stat-number" id="visitedCount">0</span>
                        <span class="stat-label">Visitados</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-list"></i></div>
                    <div class="stat-info">
                        <span class="stat-number" id="totalCount">0</span>
                        <span class="stat-label">Total</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-percentage"></i></div>
                    <div class="stat-info">
                        <span class="stat-number" id="percentage">0%</span>
                        <span class="stat-label">Progreso</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="container">
            <div class="tabs">
                <button class="tab-button active" data-tab="list">
                    <i class="fas fa-list"></i>
                    <span>Lista</span>
                </button>
                <button class="tab-button" data-tab="map">
                    <i class="fas fa-map"></i>
                    <span>Mapa</span>
                </button>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="container">
            <div class="tab-content active" id="listTab">
                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar pueblo mÃ¡gico...">
                    </div>
                    <div class="filter-box">
                        <i class="fas fa-filter"></i>
                        <select id="stateFilter">
                            <option value="">Todos los estados</option>
                        </select>
                    </div>
                    <button class="btn-clear" id="clearAll">
                        <i class="fas fa-times-circle"></i>
                        <span>Limpiar</span>
                    </button>
                </div>
                <div class="pueblos-grid" id="pueblosList"></div>
            </div>

            <div class="tab-content" id="mapTab">
                <div class="map-info">
                    <p><i class="fas fa-info-circle"></i> Marcadores verdes: Pueblos visitados</p>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </main>

    <div class="share-buttons">
        <button class="share-btn btn-instagram" id="shareInstagram">
            <i class="fab fa-instagram"></i>
            <span>Compartir en Instagram</span>
        </button>
        <button class="share-btn btn-facebook" id="shareFacebook">
            <i class="fab fa-facebook-f"></i>
            <span>Compartir en Facebook</span>
        </button>
        <button class="share-btn btn-tiktok" id="shareTikTok">
            <i class="fab fa-tiktok"></i>
            <span>Compartir en TikTok</span>
        </button>
    </div>

    <div class="share-modal" id="shareModal">
        <div class="share-content">
            <div class="share-header">
                <h2 class="share-title">
                    <i class="fas fa-share-alt"></i>
                    Mi Recorrido por MÃ©xico
                </h2>
                <button class="btn-close-modal" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="share-stats">
                <div class="share-stat">
                    <span class="share-stat-number" id="shareVisitedCount">0</span>
                    <span class="share-stat-label">Visitados</span>
                </div>
                <div class="share-stat">
                    <span class="share-stat-number" id="shareTotalCount">177</span>
                    <span class="share-stat-label">Total</span>
                </div>
                <div class="share-stat">
                    <span class="share-stat-number" id="sharePercentage">0%</span>
                    <span class="share-stat-label">Progreso</span>
                </div>
            </div>
            
            <div id="shareMap"></div>
            
            <div class="share-actions">
                <button class="btn-download" id="downloadImage">
                    <i class="fas fa-download"></i>
                    <span>Descargar Imagen</span>
                </button>
                <button class="btn-copy-link" id="copyLink">
                    <i class="fas fa-link"></i>
                    <span>Copiar Enlace</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Canvas oculto para generar imagen de Instagram Stories -->
    <div id="instagramCanvas">
        <div class="ig-container">
            <div class="ig-header">
                <div class="ig-title">ðŸ‡²ðŸ‡½ Pueblos MÃ¡gicos ðŸ‡²ðŸ‡½</div>
                <div class="ig-subtitle">Mi Recorrido por MÃ©xico</div>
            </div>
            
            <div class="ig-stats-container">
                <div class="ig-stats-grid">
                    <div class="ig-stat-card">
                        <span class="ig-stat-number" id="igVisitedCount">0</span>
                        <span class="ig-stat-label">Visitados</span>
                    </div>
                    <div class="ig-stat-card">
                        <span class="ig-stat-number" id="igTotalCount">177</span>
                        <span class="ig-stat-label">Total</span>
                    </div>
                    <div class="ig-stat-card">
                        <span class="ig-stat-number" id="igPercentage">0%</span>
                        <span class="ig-stat-label">Progreso</span>
                    </div>
                </div>
                
                <div class="ig-map-container" id="igMapContainer"></div>
            </div>
            
            <div class="ig-footer">
                <div class="ig-footer-text">âœ¨ Descubre mÃ¡s pueblos mÃ¡gicos âœ¨</div>
                <div class="ig-footer-url">pueblosmagicos.com</div>
            </div>
        </div>
    </div>

    <!-- Overlay de carga -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Generando imagen para Instagram...</div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Mis Pueblos MÃ¡gicos de MÃ©xico</p>
            <p class="footer-note">Datos almacenados localmente en tu dispositivo</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
const pueblosMagicos = [
    {id:1,name:"Calvillo",state:"Aguascalientes",lat:21.8469,lng:-102.7186},
    {id:2,name:"PabellÃ³n de Hidalgo",state:"Aguascalientes",lat:22.15,lng:-102.35},
    {id:3,name:"Real de Asientos",state:"Aguascalientes",lat:22.2389,lng:-102.0889},
    {id:4,name:"San JosÃ© de Gracia",state:"Aguascalientes",lat:22.1431,lng:-102.4089},
    {id:5,name:"Tecate",state:"Baja California",lat:32.5772,lng:-116.6289},
    {id:6,name:"Loreto",state:"Baja California Sur",lat:26.0119,lng:-111.3478},
    {id:7,name:"Santa RosalÃ­a",state:"Baja California Sur",lat:27.3333,lng:-112.2667},
    {id:8,name:"Todos Santos",state:"Baja California Sur",lat:23.4453,lng:-110.2261},
    {id:9,name:"Candelaria",state:"Campeche",lat:18.1667,lng:-91.05},
    {id:10,name:"Isla Aguada",state:"Campeche",lat:18.7667,lng:-91.4833},
    {id:11,name:"Palizada",state:"Campeche",lat:18.25,lng:-92.0833},
    {id:12,name:"Chiapa de Corzo",state:"Chiapas",lat:16.7064,lng:-93.0114},
    {id:13,name:"ComitÃ¡n",state:"Chiapas",lat:16.25,lng:-92.1333},
    {id:14,name:"CopainalÃ¡",state:"Chiapas",lat:17.1667,lng:-93.2833},
    {id:15,name:"Ocozocoautla de Espinosa",state:"Chiapas",lat:16.7667,lng:-93.3833},
    {id:16,name:"Palenque",state:"Chiapas",lat:17.5089,lng:-91.9819},
    {id:17,name:"San CristÃ³bal de las Casas",state:"Chiapas",lat:16.737,lng:-92.6376},
    {id:18,name:"Batopilas",state:"Chihuahua",lat:27.0333,lng:-107.7333},
    {id:19,name:"Casas Grandes",state:"Chihuahua",lat:30.3667,lng:-107.95},
    {id:20,name:"Creel",state:"Chihuahua",lat:27.75,lng:-107.6333},
    {id:21,name:"Guachochi",state:"Chihuahua",lat:26.8167,lng:-107.0667},
    {id:22,name:"Hidalgo del Parral",state:"Chihuahua",lat:26.9333,lng:-105.6667},
    {id:23,name:"Arteaga",state:"Coahuila",lat:25.4833,lng:-100.8167},
    {id:24,name:"Candela",state:"Coahuila",lat:26.8833,lng:-100.6667},
    {id:25,name:"Cuatro CiÃ©negas",state:"Coahuila",lat:26.9833,lng:-102.0667},
    {id:26,name:"General Cepeda",state:"Coahuila",lat:25.3667,lng:-101.4833},
    {id:27,name:"Guerrero",state:"Coahuila",lat:28.5667,lng:-100.3833},
    {id:28,name:"MÃºzquiz",state:"Coahuila",lat:27.8833,lng:-101.5167},
    {id:29,name:"Parras de la Fuente",state:"Coahuila",lat:25.4333,lng:-102.1833},
    {id:30,name:"Viesca",state:"Coahuila",lat:25.35,lng:-102.8},
    {id:31,name:"Comala",state:"Colima",lat:19.3167,lng:-103.75},
    {id:32,name:"MapimÃ­",state:"Durango",lat:25.8333,lng:-103.85},
    {id:33,name:"Nombre de Dios",state:"Durango",lat:23.8333,lng:-104.2333},
    {id:34,name:"Aculco",state:"Estado de MÃ©xico",lat:20.0833,lng:-99.8167},
    {id:35,name:"Angangeo",state:"MichoacÃ¡n",lat:19.6333,lng:-100.3},
    {id:36,name:"El Oro",state:"Estado de MÃ©xico",lat:19.8,lng:-100.1333},
    {id:37,name:"Ixtapan de la Sal",state:"Estado de MÃ©xico",lat:18.8333,lng:-99.6833},
    {id:38,name:"Malinalco",state:"Estado de MÃ©xico",lat:18.95,lng:-99.5},
    {id:39,name:"Metepec",state:"Estado de MÃ©xico",lat:19.25,lng:-99.6},
    {id:40,name:"San Juan TeotihuacÃ¡n",state:"Estado de MÃ©xico",lat:19.6833,lng:-98.85},
    {id:41,name:"TeotihuacÃ¡n",state:"Estado de MÃ©xico",lat:19.6925,lng:-98.8438},
    {id:42,name:"TepotzotlÃ¡n",state:"Estado de MÃ©xico",lat:19.7167,lng:-99.2167},
    {id:43,name:"Valle de Bravo",state:"Estado de MÃ©xico",lat:19.1936,lng:-100.1319},
    {id:44,name:"Villa del CarbÃ³n",state:"Estado de MÃ©xico",lat:19.7333,lng:-99.4667},
    {id:45,name:"XonacatlÃ¡n",state:"Estado de MÃ©xico",lat:19.4,lng:-99.55},
    {id:46,name:"Dolores Hidalgo",state:"Guanajuato",lat:21.1561,lng:-100.9311},
    {id:47,name:"Jalpa de CÃ¡novas",state:"Guanajuato",lat:21.0167,lng:-101.4667},
    {id:48,name:"Mineral de Pozos",state:"Guanajuato",lat:21.3167,lng:-100.4833},
    {id:49,name:"Salvatierra",state:"Guanajuato",lat:20.2139,lng:-100.8833},
    {id:50,name:"San Luis de la Paz",state:"Guanajuato",lat:21.2981,lng:-100.5161},
    {id:51,name:"Yuriria",state:"Guanajuato",lat:20.2119,lng:-101.1339},
    {id:52,name:"Taxco de AlarcÃ³n",state:"Guerrero",lat:18.5567,lng:-99.6058},
    {id:53,name:"Tixtla de Guerrero",state:"Guerrero",lat:17.5667,lng:-99.4},
    {id:54,name:"Zihuatanejo de Azueta",state:"Guerrero",lat:17.6333,lng:-101.55},
    {id:55,name:"Huasca de Ocampo",state:"Hidalgo",lat:20.2,lng:-98.5667},
    {id:56,name:"Huichapan",state:"Hidalgo",lat:20.3667,lng:-99.65},
    {id:57,name:"Mineral del Chico",state:"Hidalgo",lat:20.2,lng:-98.7333},
    {id:58,name:"Mineral del Monte",state:"Hidalgo",lat:20.1333,lng:-98.6667},
    {id:59,name:"Pacula",state:"Hidalgo",lat:20.9833,lng:-99.6333},
    {id:60,name:"Real del Monte",state:"Hidalgo",lat:20.1333,lng:-98.6667},
    {id:61,name:"Tecozautla",state:"Hidalgo",lat:20.5333,lng:-99.6333},
    {id:62,name:"Zempoala",state:"Hidalgo",lat:19.9167,lng:-98.6667},
    {id:63,name:"ZimapÃ¡n",state:"Hidalgo",lat:20.7333,lng:-99.3833},
    {id:64,name:"Ajijic",state:"Jalisco",lat:20.3,lng:-103.2667},
    {id:65,name:"Chapala",state:"Jalisco",lat:20.2981,lng:-103.1931},
    {id:66,name:"Lagos de Moreno",state:"Jalisco",lat:21.3583,lng:-101.9219},
    {id:67,name:"Mazamitla",state:"Jalisco",lat:19.9167,lng:-103.0167},
    {id:68,name:"San Gabriel",state:"Jalisco",lat:20.2167,lng:-102.7667},
    {id:69,name:"San SebastiÃ¡n del Oeste",state:"Jalisco",lat:20.7667,lng:-104.8167},
    {id:70,name:"Tapalpa",state:"Jalisco",lat:19.9433,lng:-103.7533},
    {id:71,name:"Talpa de Allende",state:"Jalisco",lat:20.3833,lng:-104.85},
    {id:72,name:"Tequila",state:"Jalisco",lat:20.8819,lng:-103.8353},
    {id:73,name:"Tlaquepaque",state:"Jalisco",lat:20.6417,lng:-103.3136},
    {id:74,name:"TonalÃ¡",state:"Jalisco",lat:20.6219,lng:-103.2322},
    {id:75,name:"Zapopan",state:"Jalisco",lat:20.7208,lng:-103.3919},
    {id:76,name:"Angangueo",state:"MichoacÃ¡n",lat:19.6167,lng:-100.2833},
    {id:77,name:"Cuitzeo",state:"MichoacÃ¡n",lat:19.9667,lng:-101.1333},
    {id:78,name:"Jiquilpan",state:"MichoacÃ¡n",lat:20.0333,lng:-102.7167},
    {id:79,name:"PÃ¡tzcuaro",state:"MichoacÃ¡n",lat:19.5167,lng:-101.6083},
    {id:80,name:"Santa Clara del Cobre",state:"MichoacÃ¡n",lat:19.4,lng:-101.6333},
    {id:81,name:"TacÃ¡mbaro",state:"MichoacÃ¡n",lat:19.2333,lng:-101.4667},
    {id:82,name:"Tlalpujahua",state:"MichoacÃ¡n",lat:19.8,lng:-100.1833},
    {id:83,name:"Tzintzuntzan",state:"MichoacÃ¡n",lat:19.6264,lng:-101.5778},
    {id:84,name:"TzintzuntzÃ¡n",state:"MichoacÃ¡n",lat:19.6264,lng:-101.5778},
    {id:85,name:"ZitÃ¡cuaro",state:"MichoacÃ¡n",lat:19.4333,lng:-100.35},
    {id:86,name:"Huasca",state:"Hidalgo",lat:20.2083,lng:-98.5833},
    {id:87,name:"TepoztlÃ¡n",state:"Morelos",lat:18.9872,lng:-99.0939},
    {id:88,name:"Tlayacapan",state:"Morelos",lat:18.9556,lng:-98.9797},
    {id:89,name:"Xochicalco",state:"Morelos",lat:18.7989,lng:-99.2969},
    {id:90,name:"Yecapixtla",state:"Morelos",lat:18.8833,lng:-98.8667},
    {id:91,name:"Chacala",state:"Nayarit",lat:21.1667,lng:-105.2167},
    {id:92,name:"Compostela",state:"Nayarit",lat:21.2333,lng:-104.9},
    {id:93,name:"Jala",state:"Nayarit",lat:21.0667,lng:-104.4833},
    {id:94,name:"MexcaltitÃ¡n",state:"Nayarit",lat:21.8833,lng:-105.4667},
    {id:95,name:"RincÃ³n de Guayabitos",state:"Nayarit",lat:21.0333,lng:-105.2667},
    {id:96,name:"San Blas",state:"Nayarit",lat:21.5425,lng:-105.2847},
    {id:97,name:"Sayulita",state:"Nayarit",lat:20.8667,lng:-105.45},
    {id:98,name:"Tepic",state:"Nayarit",lat:21.5042,lng:-104.8942},
    {id:99,name:"Xalisco",state:"Nayarit",lat:21.45,lng:-104.9},
    {id:100,name:"Arteaga",state:"Nuevo LeÃ³n",lat:25.4667,lng:-100.8333},
    {id:101,name:"Linares",state:"Nuevo LeÃ³n",lat:24.8575,lng:-99.5689},
    {id:102,name:"Rayones",state:"Nuevo LeÃ³n",lat:25.0167,lng:-100.1167},
    {id:103,name:"Santiago",state:"Nuevo LeÃ³n",lat:25.4333,lng:-100.15},
    {id:104,name:"Villa de Santiago",state:"Nuevo LeÃ³n",lat:25.4167,lng:-100.15},
    {id:105,name:"CapulÃ¡lpam de MÃ©ndez",state:"Oaxaca",lat:17.3,lng:-96.4333},
    {id:106,name:"Huautla de JimÃ©nez",state:"Oaxaca",lat:18.1333,lng:-96.8333},
    {id:107,name:"Mazunte",state:"Oaxaca",lat:15.6667,lng:-96.55},
    {id:108,name:"San Pablo Villa de Mitla",state:"Oaxaca",lat:16.9272,lng:-96.3678},
    {id:109,name:"San Pedro y San Pablo Teposcolula",state:"Oaxaca",lat:17.5167,lng:-97.4833},
    {id:110,name:"Santa Catarina Juquila",state:"Oaxaca",lat:16.2333,lng:-97.3},
    {id:111,name:"Chignahuapan",state:"Puebla",lat:19.8333,lng:-98.0333},
    {id:112,name:"Cuetzalan",state:"Puebla",lat:20.0333,lng:-97.5167},
    {id:113,name:"Huauchinango",state:"Puebla",lat:20.1833,lng:-98.05},
    {id:114,name:"PahuatlÃ¡n",state:"Puebla",lat:20.25,lng:-98.1833},
    {id:115,name:"Tlatlauquitepec",state:"Puebla",lat:19.8333,lng:-97.5167},
    {id:116,name:"Xicotepec",state:"Puebla",lat:20.2667,lng:-97.9667},
    {id:117,name:"ZacatlÃ¡n",state:"Puebla",lat:19.9333,lng:-97.9667},
    {id:118,name:"Cholula",state:"Puebla",lat:19.0642,lng:-98.3064},
    {id:119,name:"Atlixco",state:"Puebla",lat:18.9,lng:-98.4333},
    {id:120,name:"Cuetzalan del Progreso",state:"Puebla",lat:20.0333,lng:-97.5167},
    {id:121,name:"Tetela de Ocampo",state:"Puebla",lat:19.8167,lng:-97.8},
    {id:122,name:"Tlaxco",state:"Puebla",lat:19.6167,lng:-98.1167},
    {id:123,name:"ZacatlÃ¡n de las Manzanas",state:"Puebla",lat:19.9333,lng:-97.9667},
    {id:124,name:"Amealco de Bonfil",state:"QuerÃ©taro",lat:20.1833,lng:-100.15},
    {id:125,name:"Bernal",state:"QuerÃ©taro",lat:20.7333,lng:-99.95},
    {id:126,name:"Cadereyta de Montes",state:"QuerÃ©taro",lat:20.7,lng:-99.8167},
    {id:127,name:"Jalpan de Serra",state:"QuerÃ©taro",lat:21.2167,lng:-99.4667},
    {id:128,name:"PeÃ±a de Bernal",state:"QuerÃ©taro",lat:20.7422,lng:-99.9428},
    {id:129,name:"San JoaquÃ­n",state:"QuerÃ©taro",lat:21.0167,lng:-99.5667},
    {id:130,name:"Tequisquiapan",state:"QuerÃ©taro",lat:20.5167,lng:-99.8833},
    {id:131,name:"Bacalar",state:"Quintana Roo",lat:18.6811,lng:-88.3956},
    {id:132,name:"Isla Mujeres",state:"Quintana Roo",lat:21.2311,lng:-86.7308},
    {id:133,name:"Tulum",state:"Quintana Roo",lat:20.2114,lng:-87.4292},
    {id:134,name:"Izamal",state:"YucatÃ¡n",lat:20.9333,lng:-89.0167},
    {id:135,name:"ArmerÃ­a",state:"Colima",lat:18.9417,lng:-103.9653},
    {id:136,name:"AquismÃ³n",state:"San Luis PotosÃ­",lat:21.5833,lng:-99.0333},
    {id:137,name:"Real de Catorce",state:"San Luis PotosÃ­",lat:23.6836,lng:-100.8828},
    {id:138,name:"Santa MarÃ­a del RÃ­o",state:"San Luis PotosÃ­",lat:21.8,lng:-100.7333},
    {id:139,name:"Tamasopo",state:"San Luis PotosÃ­",lat:21.9167,lng:-99.3833},
    {id:140,name:"Xilitla",state:"San Luis PotosÃ­",lat:21.3833,lng:-98.9833},
    {id:141,name:"Ciudad Valles",state:"San Luis PotosÃ­",lat:21.9833,lng:-99.0167},
    {id:142,name:"CosalÃ¡",state:"Sinaloa",lat:24.4167,lng:-106.6833},
    {id:143,name:"El Fuerte",state:"Sinaloa",lat:26.4167,lng:-108.6167},
    {id:144,name:"El Rosario",state:"Sinaloa",lat:22.9833,lng:-105.8667},
    {id:145,name:"Mocorito",state:"Sinaloa",lat:25.4833,lng:-107.9167},
    {id:146,name:"Sinaloa de Leyva",state:"Sinaloa",lat:25.85,lng:-108.1},
    {id:147,name:"Ãlamos",state:"Sonora",lat:27.0236,lng:-108.9428},
    {id:148,name:"Magdalena de Kino",state:"Sonora",lat:30.6167,lng:-111.05},
    {id:149,name:"Pitiquito",state:"Sonora",lat:30.6833,lng:-112.0333},
    {id:150,name:"San Carlos Nuevo Guaymas",state:"Sonora",lat:27.9333,lng:-111.0667},
    {id:151,name:"Jalpa de MÃ©ndez",state:"Tabasco",lat:18.1333,lng:-93.0667},
    {id:152,name:"Tapijulapa",state:"Tabasco",lat:17.4833,lng:-92.7667},
    {id:153,name:"Mier",state:"Tamaulipas",lat:26.4333,lng:-99.1333},
    {id:154,name:"Tula",state:"Tamaulipas",lat:23.0167,lng:-99.7167},
    {id:155,name:"Huamantla",state:"Tlaxcala",lat:19.3167,lng:-97.9167},
    {id:156,name:"Tlaxco",state:"Tlaxcala",lat:19.6167,lng:-98.1167},
    {id:157,name:"San Pablo del Monte",state:"Tlaxcala",lat:19.2,lng:-98.2},
    {id:158,name:"Coatepec",state:"Veracruz",lat:19.45,lng:-96.9667},
    {id:159,name:"Coscomatepec",state:"Veracruz",lat:19.0667,lng:-97.05},
    {id:160,name:"Papantla",state:"Veracruz",lat:20.4553,lng:-97.3158},
    {id:161,name:"Tlacotalpan",state:"Veracruz",lat:18.6128,lng:-95.6561},
    {id:162,name:"Xico",state:"Veracruz",lat:19.4167,lng:-97.0},
    {id:163,name:"Zozocolco de Hidalgo",state:"Veracruz",lat:20.1333,lng:-97.5833},
    {id:164,name:"Naolinco",state:"Veracruz",lat:19.6536,lng:-96.9003},
    {id:165,name:"Zempoala",state:"Veracruz",lat:19.45,lng:-96.4167},
    {id:166,name:"Izamal",state:"YucatÃ¡n",lat:20.9303,lng:-89.0211},
    {id:167,name:"ManÃ­",state:"YucatÃ¡n",lat:20.3833,lng:-89.45},
    {id:168,name:"Sisal",state:"YucatÃ¡n",lat:21.1667,lng:-90.0333},
    {id:169,name:"Valladolid",state:"YucatÃ¡n",lat:20.6897,lng:-88.2031},
    {id:170,name:"Espita",state:"YucatÃ¡n",lat:21.0167,lng:-88.3},
    {id:171,name:"Motul",state:"YucatÃ¡n",lat:21.0989,lng:-89.2781},
    {id:172,name:"Tecoh",state:"YucatÃ¡n",lat:20.7444,lng:-89.4772},
    {id:173,name:"El Teul de GonzÃ¡lez Ortega",state:"Zacatecas",lat:21.4667,lng:-103.4},
    {id:174,name:"Jerez de GarcÃ­a Salinas",state:"Zacatecas",lat:22.65,lng:-102.9833},
    {id:175,name:"NochistlÃ¡n de MejÃ­a",state:"Zacatecas",lat:21.3667,lng:-102.85},
    {id:176,name:"Pinos",state:"Zacatecas",lat:22.2667,lng:-101.5833},
    {id:177,name:"Sombrerete",state:"Zacatecas",lat:23.6333,lng:-103.6333},
    {id:178,name:"Teul de GonzÃ¡lez Ortega",state:"Zacatecas",lat:21.4667,lng:-103.4},
    {id:179,name:"Guadalupe",state:"Zacatecas",lat:22.75,lng:-102.5167}
];

let visitedPueblos = new Set();
let map = null;
let markers = [];

document.addEventListener('DOMContentLoaded', () => {
    loadVisitedPueblos();
    initializeTabs();
    initializeControls();
    renderPueblos();
    updateStats();
    populateStateFilter();
    initializeShareButtons();
});

function loadVisitedPueblos() {
    const saved = localStorage.getItem('visitedPueblos');
    if (saved) visitedPueblos = new Set(JSON.parse(saved));
}

function saveVisitedPueblos() {
    localStorage.setItem('visitedPueblos', JSON.stringify([...visitedPueblos]));
}

function initializeTabs() {
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabName = button.dataset.tab;
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tabName === 'list') {
                document.getElementById('listTab').classList.add('active');
            } else if (tabName === 'map') {
                document.getElementById('mapTab').classList.add('active');
                initializeMap();
            }
        });
    });
}

function initializeControls() {
    const searchInput = document.getElementById('searchInput');
    const stateFilter = document.getElementById('stateFilter');
    const clearButton = document.getElementById('clearAll');
    
    searchInput.addEventListener('input', (e) => renderPueblos(e.target.value.toLowerCase(), stateFilter.value));
    stateFilter.addEventListener('change', (e) => renderPueblos(searchInput.value.toLowerCase(), e.target.value));
    
    clearButton.addEventListener('click', () => {
        if (visitedPueblos.size === 0) return;
        if (confirm('Â¿EstÃ¡s seguro de que quieres limpiar todos los pueblos visitados?')) {
            visitedPueblos.clear();
            saveVisitedPueblos();
            renderPueblos();
            updateStats();
            if (map) updateMapMarkers();
        }
    });
}

function populateStateFilter() {
    const stateFilter = document.getElementById('stateFilter');
    const states = [...new Set(pueblosMagicos.map(p => p.state))].sort();
    states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateFilter.appendChild(option);
    });
}

function renderPueblos(searchTerm = '', stateFilter = '') {
    const pueblosList = document.getElementById('pueblosList');
    let filteredPueblos = pueblosMagicos.filter(pueblo => {
        const matchesSearch = pueblo.name.toLowerCase().includes(searchTerm) || pueblo.state.toLowerCase().includes(searchTerm);
        const matchesState = !stateFilter || pueblo.state === stateFilter;
        return matchesSearch && matchesState;
    });
    
    if (filteredPueblos.length === 0) {
        pueblosList.innerHTML = `<div class="empty-state" style="grid-column: 1/-1;"><i class="fas fa-search"></i><h3>No se encontraron resultados</h3><p>Intenta con otros tÃ©rminos de bÃºsqueda</p></div>`;
        return;
    }
    
    pueblosList.innerHTML = filteredPueblos.map(pueblo => `
        <div class="pueblo-card ${visitedPueblos.has(pueblo.id) ? 'visited' : ''}" data-id="${pueblo.id}">
            <div class="pueblo-header">
                <h3 class="pueblo-name">${pueblo.name}</h3>
                <input type="checkbox" class="pueblo-checkbox" ${visitedPueblos.has(pueblo.id) ? 'checked' : ''} data-id="${pueblo.id}">
            </div>
            <div class="pueblo-state"><i class="fas fa-map-marker-alt"></i><span>${pueblo.state}</span></div>
        </div>
    `).join('');
    
    document.querySelectorAll('.pueblo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handlePuebloToggle);
    });
    
    document.querySelectorAll('.pueblo-card').forEach(card => {
        card.addEventListener('click', (e) => {
            if (e.target.classList.contains('pueblo-checkbox')) return;
            const checkbox = card.querySelector('.pueblo-checkbox');
            checkbox.checked = !checkbox.checked;
            handlePuebloToggle({ target: checkbox });
        });
    });
}

function handlePuebloToggle(e) {
    const puebloId = parseInt(e.target.dataset.id);
    const card = e.target.closest('.pueblo-card');
    if (e.target.checked) {
        visitedPueblos.add(puebloId);
        card.classList.add('visited');
    } else {
        visitedPueblos.delete(puebloId);
        card.classList.remove('visited');
    }
    saveVisitedPueblos();
    updateStats();
    if (map) updateMapMarkers();
}

function updateStats() {
    const totalCount = pueblosMagicos.length;
    const visitedCount = visitedPueblos.size;
    const percentage = totalCount > 0 ? Math.round((visitedCount / totalCount) * 100) : 0;
    document.getElementById('visitedCount').textContent = visitedCount;
    document.getElementById('totalCount').textContent = totalCount;
    document.getElementById('percentage').textContent = `${percentage}%`;
}

function initializeMap() {
    if (map) {
        updateMapMarkers();
        return;
    }
    map = L.map('map').setView([23.6345, -102.5528], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    updateMapMarkers();
    setTimeout(() => map.invalidateSize(), 300);
}

function updateMapMarkers() {
    if (!map) return;
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    const visitedPueblosData = pueblosMagicos.filter(p => visitedPueblos.has(p.id));
    if (visitedPueblosData.length === 0) return;
    visitedPueblosData.forEach(pueblo => {
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const marker = L.marker([pueblo.lat, pueblo.lng], { icon: greenIcon })
            .bindPopup(`<div style="text-align: center;"><strong style="font-size: 1.1rem;">${pueblo.name}</strong><br><span style="color: #666;">${pueblo.state}</span></div>`)
            .addTo(map);
        markers.push(marker);
    });
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
}

let shareMap = null;
function initializeShareButtons() {
    const shareInstagram = document.getElementById('shareInstagram');
    const shareFacebook = document.getElementById('shareFacebook');
    const shareTikTok = document.getElementById('shareTikTok');
    const shareModal = document.getElementById('shareModal');
    const closeModal = document.getElementById('closeModal');
    const downloadImage = document.getElementById('downloadImage');
    const copyLink = document.getElementById('copyLink');
    
    shareInstagram.addEventListener('click', () => openShareModal('instagram'));
    shareFacebook.addEventListener('click', () => openShareModal('facebook'));
    shareTikTok.addEventListener('click', () => openShareModal('tiktok'));
    
    closeModal.addEventListener('click', () => {
        shareModal.classList.remove('active');
    });
    
    shareModal.addEventListener('click', (e) => {
        if (e.target === shareModal) {
            shareModal.classList.remove('active');
        }
    });
    
    downloadImage.addEventListener('click', downloadShareImage);
    copyLink.addEventListener('click', copyShareLink);
}

function openShareModal(platform) {
    if (visitedPueblos.size === 0) {
        alert('Â¡Primero marca algunos pueblos como visitados!');
        return;
    }
    
    // Si es Instagram, generar imagen automÃ¡ticamente
    if (platform === 'instagram') {
        generateInstagramStory();
        return;
    }
    
    // Para otras plataformas, abrir el modal normal
    const shareModal = document.getElementById('shareModal');
    shareModal.classList.add('active');
    
    document.getElementById('shareVisitedCount').textContent = visitedPueblos.size;
    document.getElementById('shareTotalCount').textContent = pueblosMagicos.length;
    const percentage = Math.round((visitedPueblos.size / pueblosMagicos.length) * 100);
    document.getElementById('sharePercentage').textContent = `${percentage}%`;
    
    setTimeout(() => initializeShareMap(), 300);
}

function initializeShareMap() {
    if (shareMap) {
        shareMap.remove();
    }
    
    shareMap = L.map('shareMap').setView([23.6345, -102.5528], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap',
        maxZoom: 18
    }).addTo(shareMap);
    
    const visitedPueblosData = pueblosMagicos.filter(p => visitedPueblos.has(p.id));
    const shareMarkers = [];
    
    visitedPueblosData.forEach(pueblo => {
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const marker = L.marker([pueblo.lat, pueblo.lng], { icon: greenIcon })
            .bindPopup(`<div style="text-align: center;"><strong style="font-size: 1.1rem;">${pueblo.name}</strong><br><span style="color: #666;">${pueblo.state}</span></div>`)
            .addTo(shareMap);
        shareMarkers.push(marker);
    });
    
    if (shareMarkers.length > 0) {
        const group = L.featureGroup(shareMarkers);
        shareMap.fitBounds(group.getBounds().pad(0.1));
    }
    
    setTimeout(() => shareMap.invalidateSize(), 300);
}

// Variable global para el mapa de Instagram
let igMap = null;

// Generar imagen automÃ¡tica para Instagram Stories
async function generateInstagramStory() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.classList.add('active');
    
    try {
        // Actualizar estadÃ­sticas en el canvas de Instagram
        const percentage = Math.round((visitedPueblos.size / pueblosMagicos.length) * 100);
        document.getElementById('igVisitedCount').textContent = visitedPueblos.size;
        document.getElementById('igTotalCount').textContent = pueblosMagicos.length;
        document.getElementById('igPercentage').textContent = `${percentage}%`;
        
        // Posicionar el canvas temporalmente para renderizar el mapa
        const igCanvas = document.getElementById('instagramCanvas');
        igCanvas.style.top = '0';
        igCanvas.style.left = '0';
        igCanvas.style.position = 'fixed';
        igCanvas.style.zIndex = '-1';
        
        // Inicializar el mapa de Instagram
        await initializeInstagramMap();
        
        // Esperar a que el mapa se renderice completamente
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Capturar el canvas con html2canvas
        const canvas = await html2canvas(igCanvas, {
            width: 1080,
            height: 1920,
            scale: 1,
            useCORS: true,
            allowTaint: true,
            backgroundColor: null
        });
        
        // Convertir canvas a blob y descargar
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `pueblos-magicos-${visitedPueblos.size}-de-177.png`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            
            // Ocultar canvas nuevamente
            igCanvas.style.top = '-9999px';
            igCanvas.style.left = '-9999px';
            
            // Ocultar loading
            loadingOverlay.classList.remove('active');
            
            // Mostrar mensaje de Ã©xito
            alert('âœ… Â¡Imagen descargada!\n\nAhora puedes:\n1. Abrir Instagram\n2. Crear una nueva Story\n3. Seleccionar la imagen descargada\n4. Â¡Compartir! ðŸŽ‰');
        }, 'image/png', 1.0);
        
    } catch (error) {
        console.error('Error generando imagen:', error);
        loadingOverlay.classList.remove('active');
        alert('âŒ Error al generar la imagen. Por favor, intenta de nuevo.');
    }
}

// Inicializar mapa para Instagram
async function initializeInstagramMap() {
    return new Promise((resolve) => {
        const mapContainer = document.getElementById('igMapContainer');
        
        // Limpiar mapa anterior si existe
        if (igMap) {
            igMap.remove();
            igMap = null;
        }
        
        // Crear nuevo mapa
        igMap = L.map(mapContainer, {
            zoomControl: false,
            attributionControl: false
        }).setView([23.6345, -102.5528], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(igMap);
        
        // Agregar marcadores de pueblos visitados
        const visitedPueblosData = pueblosMagicos.filter(p => visitedPueblos.has(p.id));
        const markers = [];
        
        visitedPueblosData.forEach(pueblo => {
            const greenIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            const marker = L.marker([pueblo.lat, pueblo.lng], { icon: greenIcon }).addTo(igMap);
            markers.push(marker);
        });
        
        // Ajustar vista del mapa
        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            igMap.fitBounds(group.getBounds().pad(0.1));
        }
        
        // Invalidar tamaÃ±o del mapa y resolver promesa
        setTimeout(() => {
            igMap.invalidateSize();
            resolve();
        }, 500);
    });
}

function downloadShareImage() {
    const percentage = Math.round((visitedPueblos.size / pueblosMagicos.length) * 100);
    alert(`ðŸ“¸ Captura tu recorrido por los Pueblos MÃ¡gicos\n\nÂ¡${visitedPueblos.size} pueblos visitados! (${percentage}% completado)\n\nUsa la herramienta de captura de pantalla:\n\nðŸ“± MÃ³vil: Captura de pantalla\nðŸ’» PC: Win+Shift+S (Windows) o Cmd+Shift+4 (Mac)`);
}

function copyShareLink() {
    const url = window.location.href;
    const percentage = Math.round((visitedPueblos.size / pueblosMagicos.length) * 100);
    const text = `Mi recorrido por los Pueblos MÃ¡gicos de MÃ©xico ðŸ‡²ðŸ‡½âœ¨\n\nÂ¡Ya visitÃ© ${visitedPueblos.size} de 177 Pueblos MÃ¡gicos! (${percentage}% completado)\n\nMira mi progreso completo: ${url}`;
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            alert('âœ… Enlace copiado al portapapeles');
        }).catch(() => {
            fallbackCopyText(text);
        });
    } else {
        fallbackCopyText(text);
    }
}

function fallbackCopyText(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        alert('âœ… Enlace copiado al portapapeles');
    } catch (err) {
        alert('âŒ No se pudo copiar. Por favor, copia manualmente: ' + text);
    }
    document.body.removeChild(textArea);
}
    </script>
</body>
</html>
